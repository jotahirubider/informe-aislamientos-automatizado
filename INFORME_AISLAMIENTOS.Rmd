---
title: "INFORME DE SEGUIMIENTO DE PACIENTES CON PRECAUCIONES DE AISLAMIENTO"
output:
  pdf_document: default
date: "`r format(Sys.time(), '%d-%m-%Y %H:00')`"
df_print: paged
geometry: left=3cm,right=3cm,top=1.5cm,bottom=5cm
header-includes: \usepackage{graphicx} \usepackage{lscape} \usepackage[export]{adjustbox}
  \newcommand{\blandscape}{\begin{landscape}} \newcommand{\elandscape}{\end{landscape}}
  \usepackage{fancyhdr} \pagestyle{fancyplain} \usepackage{caption} \setlength\headheight{2cm}
  \fancyhead[L]{ \includegraphics[width=3cm,valign=c]{UTILS/logo_lafe.jpg}} \fancyhead[R]{
  \begin{tabular}{l} Servicio de \\ Medicina Preventiva \\ y Salud Pública \end{tabular}
  } \fancyfoot[LE,RO]{} \setlength{\headheight}{75pt}
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(
# 	fig.height = ggplot2::unit(7.5, "cm"),
# 	fig.width = ggplot2::unit(15, "cm"),
# 	cache = TRUE
# )
knitr::opts_knit$set(root.dir="//woody/asan/Servicios/EnfermeriaMedPreventiva/AISLAMIENTOS TODO/EXCEL AISLAMIENTOS/INFORMES")
pacman::p_load(readxl,rmarkdown,tidyverse,lubridate,knitr,RODBC,
               kableExtra)

```

# Introducción

La transmisión de microorganismos dentro de un entorno sanitario requiere tres elementos: la fuente o reservorio, un huésped susceptible y un modo de transmisión. El aislamiento es una de las herramientas utilizadas para interrumpir o al menos limitar, la transmisión intrahospitalaria de microorganismos y enfermedades epidemiológicamente relevantes.

A continuación, se exponen los pacientes ingresados con precauciones de transmisión ampliadas en el momento de remisión de este informe. Se añaden dos indicadores por unidad de hospitalización y una tabla resumen agregada al final del documento.

```{r include=FALSE}
percent <- function(proportion) {
  paste0(sprintf("%2.1f",proportion * 100),"%")
}
con <- odbcConnectAccess("//woody/asan/Servicios/EnfermeriaMedPreventiva/AISLAMIENTOS TODO/EXCEL AISLAMIENTOS/Epi Info 7/Projects/IRAS/IRAS.mdb")
tb1 <- sqlFetch(con, "Vigilancia")
tb2 <-sqlFetch(con, "Vigilancia1")
tb3 <-sqlFetch(con, "Vigilancia12")
tb4 <-sqlFetch(con, "Vigilancia13")
odbcClose(con)
full_tb <- left_join(tb1,tb2,by="GlobalRecordId") %>% 
  left_join(.,tb3,by="GlobalRecordId") %>% 
  left_join(.,tb4,by="GlobalRecordId")
validos <- full_tb %>% filter(RECSTATUS==1)
activos <- validos %>% filter(estadoActual=="ACTIVO")
rm(tb1,tb2,tb3,tb4,validos)

micro <- activos %>% 
  select(GlobalRecordId,
         starts_with("microorganismo"),
         starts_with("fechaMuestra"),
         starts_with("mecanismoMR")
         ) %>% 
  mutate(across(.cols = contains("fecha"),.fns = as.character.POSIXt)) %>% 
  pivot_longer(cols=-c(GlobalRecordId)) %>% 
  arrange(GlobalRecordId,str_sub(name,-1)) %>% 
  mutate(orderId=str_sub(name,-1),
         name=if_else(grepl("Estado",name),
                      "estadoAislamiento",
                      if_else(grepl("MROtro",name),
                              "otroMecanismo",
                              if_else(grepl("mecanismoMR",name),
                                      "mecanismoMR",
                                      if_else(
                                        grepl("fechaMuestra",name),
                                        "fechaMuestra",
                                        "microorganismo"
                                      )))),
         value=if_else(value=="ACTIVO" & is.na(lead(value)),
                       NA_character_,
                       value)) %>% 
  mutate(value=ifelse(
    lag(value)=="INACTIVO" & lag(orderId)==orderId & name!="estadoAislamiento",
    NA_character_,
    value
  ),
  value=ifelse(
    lag(value)=="INACTIVO" & lag(orderId,2)==orderId & name!="estadoAislamiento",
    NA_character_,
    value
  ),
  value=ifelse(
    lag(value)=="INACTIVO" & lag(orderId,3)==orderId & name!="estadoAislamiento",
    NA_character_,
    value
  ),
  value=ifelse(value=="INACTIVO",NA_character_,value)) %>% 
  filter(!is.na(value))
micro2 <- micro %>% pivot_wider(names_from = name,values_from = value) %>% 
  select(-estadoAislamiento) %>% 
  filter(!is.na(microorganismo)) %>% 
  distinct(GlobalRecordId,microorganismo,mecanismoMR,.keep_all = T) %>% 
  mutate(mecanismoMR=if_else(mecanismoMR=="R = 3 grupos",
                             "MR",
                             mecanismoMR),
         mecanismoMR=if_else(mecanismoMR=="Carbapenemasa",
                             "p. de carbapenemasa",
                             mecanismoMR),
         mecanismoMR=if_else(mecanismoMR=="No MR" | mecanismoMR=="Otro",
                             NA_character_,
                             mecanismoMR))

micro3 <- micro2 %>% mutate(
           microorganismo=if_else(
             is.na(mecanismoMR),
             microorganismo,
             paste(microorganismo,mecanismoMR)),
           fechaMuestra=parse_date(fechaMuestra,format = "%Y-%m-%d")
         ) %>% 
  select(-otroMecanismo,-orderId,-mecanismoMR)

tablas_informe <- activos %>% 
  select(GlobalRecordId,plantaActual,camaActual,tipoAislamiento,origenInfeccion) %>% 
  left_join(micro3,by="GlobalRecordId") %>% 
  select(plantaActual,camaActual,tipoAislamiento,origenInfeccion,microorganismo,fechaMuestra) %>% 
  mutate(tipoAislamiento=str_to_title(tipoAislamiento),
         origenInfeccion=str_to_sentence(origenInfeccion))
```

\clearpage

\captionsetup[table]{labelformat=empty}

```{r echo=FALSE, results='asis', fig.align='center'}
plantas <- tablas_informe %>% group_by(plantaActual) %>% summarise() %>% ungroup() %>% 
  .$plantaActual
plantas_criticos <- c("UMI","REA","REQ","UCN","UCP")
plantas_hosp <- setdiff(plantas,plantas_criticos)
rm(plantas)
n_camas <- read.csv2("UTILS/nCamas.csv")
print_tables <- function(plantas) {
  for (i in plantas) {
      if (i %in% tablas_informe$plantaActual) {
        to_print <- tablas_informe %>% 
        filter(plantaActual==i) %>% 
        select(-plantaActual) %>% 
        arrange(camaActual) %>% 
        mutate(
          fechaMuestra=strftime(fechaMuestra,format = "%d-%m-%Y")
          ) 
        options(knitr.kable.NA = "")
        to_print %>% 
          kable(
            col.names = c("Cama","Tipo de aislamiento","Origen","Microorganismo","Fecha 1º (+)"),
            caption = sprintf("\\textbf{%s}",i)) %>% 
          row_spec(0,bold=TRUE) %>% 
          kable_styling(latex_options = c("hold_position")
                        ) %>%
          collapse_rows(columns = c(1,2,3))  %>%
          print()
        
        n_aislados <- to_print %>% filter(camaActual!="") %>% nrow()
        n_camas_planta <- left_join(as_tibble(i),n_camas,by=c("value"="plantaActual")) %>% 
          .$nCamas
        p_camas_aisladas <- paste0(sprintf("%2.2f", n_aislados/n_camas_planta*100),"%")
        calc_nosocomial <- tablas_informe %>% 
          filter(plantaActual==i) %>% 
          select(-plantaActual) %>% 
          arrange(camaActual) %>% 
          mutate(
            tipoAislamiento=if_else(lag(camaActual)==camaActual &
                                      row_number(camaActual)!=1 &
                                      lag(tipoAislamiento)==tipoAislamiento &
                                      row_number(tipoAislamiento) != 1,
                                    NA_character_,
                                    tipoAislamiento),
            origenInfeccion=if_else(lag(camaActual)==camaActual &
                                      row_number(camaActual)!=1 &
                                      lag(origenInfeccion)==origenInfeccion &
                                      row_number(origenInfeccion) != 1,
                                    NA_character_,
                                    origenInfeccion),
            camaActual=if_else(
              lag(camaActual)==camaActual & row_number(camaActual)!=1,
              NA_character_,
              camaActual))
        p_nosocomial <- calc_nosocomial %>% 
          filter(origenInfeccion=="Nosocomial") %>% 
          nrow() /
          calc_nosocomial %>% 
          filter(!is.na(camaActual)) %>% 
          nrow() 
        p_nosocomial <-  paste0(sprintf("%2.2f",p_nosocomial * 100),"%")
        # cat("\\vspace{10mm}")
        tibble(
          "Nº Camas"=n_camas_planta,
          "% Camas aisladas"=p_camas_aisladas,
          "% Nosocomiales"=p_nosocomial
        ) %>% 
          kable(#format="latex",
            # caption = ""
            ) %>% 
          kable_styling(latex_options = "hold_position"
                        ) %>% 
          print()
      } else {next}
  }
}
```

# Unidades de Áreas Críticas

```{r echo=FALSE, results='asis', fig.align='center',}
print_tables(plantas_criticos)
```

\clearpage

# Unidades de Hospitalización

```{r echo=FALSE, results='asis', fig.align='center'}
# cat('\\center __UNIDADES DE HOSPITALIZACIÓN__ \\center')
print_tables(plantas_hosp)

```

\clearpage

\blandscape

# Indicadores globales de presión de aislamientos

```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, results='asis',fig.}
# Ns de camas
total_camas <- n_camas$nCamas %>% sum()
total_camas_crit <- n_camas %>% 
  filter(plantaActual %in% plantas_criticos)
total_camas_crit <- total_camas_crit$nCamas %>% sum()
total_camas_hosp <- total_camas - total_camas_crit
# Aislamientos totales
n_aisl_totales <- tablas_informe %>% 
  distinct(camaActual) %>% 
  nrow()
n_aisl_crit <- tablas_informe %>% 
  filter(plantaActual %in% plantas_criticos) %>% 
  distinct(camaActual) %>% 
  nrow()
n_aisl_hosp <- n_aisl_totales - n_aisl_crit
# Presion de aislamientos
pa_global <- n_aisl_totales / total_camas
pa_crit <- n_aisl_crit / total_camas_crit
pa_hosp <-n_aisl_hosp / total_camas_hosp
# Tasa aislamientos nosocomiales
n_aisl_nosocomial <- tablas_informe %>% group_by(camaActual) %>% summarise(origenInfeccion) %>% ungroup() %>% filter(origenInfeccion=="Nosocomial") %>% nrow()
ta_aisl_nosocomial <- n_aisl_nosocomial / n_aisl_totales
# Presion de aislamientos nosocomiales global
pa_aisl_nosocomial <- n_aisl_nosocomial / total_camas
# Virus respiratorios y SARS-CoV-2
n_virus_resp_total <- tablas_informe %>% filter(grepl("Gotas",tipoAislamiento) &
                                            grepl("Virus",microorganismo))
n_virus_resp <- n_virus_resp_total %>% filter(!grepl("SARS-CoV-2",microorganismo)) %>% 
  nrow()
n_covid <- n_virus_resp_total %>% filter(grepl("SARS-CoV-2",microorganismo)) %>% 
  nrow()
# Tasa y presion de aislamientos por virus respiratorios
ta_virus_resp <- n_virus_resp / n_aisl_totales
pa_virus_resp <- n_virus_resp / total_camas
pa_covid <- n_covid / total_camas
# Razon COVID / virus respiratorios
razon_covid_resp <- n_covid / n_virus_resp
# PA microorganismos
n_cauris <- tablas_informe %>% filter(grepl("Candida auris",microorganismo)) %>% nrow()
n_carba <- tablas_informe %>% filter(grepl("carbapenemasa",tolower(microorganismo))) %>% nrow()
n_cdif <- tablas_informe %>% filter(grepl("difficile",microorganismo)) %>% nrow()
n_acineto <- tablas_informe %>% filter(grepl("Acineto",microorganismo)) %>% nrow()
pa_cauris <- n_cauris/total_camas
pa_carba <-n_carba/total_camas
pa_cdif <- n_cdif/total_camas
pa_acineto <- n_acineto/total_camas
# Read indicadores previo
indicadores <- read.csv2("UTILS/indicadores_resultados.csv") %>% as_tibble() %>% 
  mutate(across(.cols = everything(), as.numeric),
         fecha=as.POSIXct(fecha))
# Agregar fila
indicadores <- indicadores %>% filter(!fecha==today()) %>%  
  add_row(fecha=today(),n_aisl_totales,pa_global,pa_crit,pa_hosp,ta_aisl_nosocomial,pa_aisl_nosocomial,ta_virus_resp,pa_virus_resp,pa_covid,razon_covid_resp,pa_cauris,pa_carba,pa_cdif,pa_acineto)
saveRDS(indicadores,file="UTILS/indicadores_resultados.rds")
write.csv2(indicadores, 
           "UTILS/indicadores_resultados.csv", row.names = F)
# Leer tabla con variables
indicadores_vars <- read_excel("UTILS/indicadores_variables.xlsx") %>% 
  mutate(calculo=gsub("/ ","/\n",calculo))
indicador_actual <- indicadores %>% 
  filter(fecha==today()) %>% 
  distinct_all() %>% 
  select(-fecha) %>% 
  pivot_longer(cols = everything(),names_to = "id_indicador", values_to = "resultado") %>%
  mutate(
    resultado=if_else(
      str_starts(string = id_indicador,pattern   = "pa") | 
        str_starts(string = id_indicador,pattern   = "ta"),
      paste0(sprintf("%2.1f",resultado*100),"%"),
      if_else(str_starts(id_indicador,"n_"),
              sprintf("%2.0f",resultado),
              sprintf("%2.1f",resultado))))

tabla_indicadores <- left_join(indicadores_vars,indicador_actual,by="id_indicador") %>% 
  select(-id_indicador)
tabla_indicadores %>% 
  kable(#format="latex",
    col.names = c("Indicador","Cálculo","Resultado"),
        linesep="\n\n\n\n") %>% 
  row_spec(0,bold=TRUE) %>% 
  kable_styling(latex_options = c("scale_down","hold_position")) %>%
  print()

```

PA: presión de aislamientos. TA: tasa de aislamientos. EPC: enterobacterias productoras de carbapenemasa.

\elandscape
